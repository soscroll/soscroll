name: Tailscale_MacOS_Remote

on:
  workflow_dispatch:

jobs:
  secure-macos:
    runs-on: macos-15  # macOS Sequoia terbaru
    timeout-minutes: 360

    steps:
      - name: Show macOS Info
        run: |
          sw_vers
          uname -a

      - name: Install Tailscale (latest)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale Daemon
        run: |
          sudo tailscaled &

      - name: Connect to Tailscale Network
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=${TS_AUTHKEY} --hostname=macos-gh-${{ github.run_id }} --accept-dns=false
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: Verify Tailscale Connection
        run: |
          echo "Tailscale IP assigned: $TAILSCALE_IP"
          tailscale status

      - name: Create SSH User
        run: |
          USERNAME="remoteuser"
          PASSWORD=$(openssl rand -base64 12)
          sudo sysadminctl -addUser $USERNAME -password $PASSWORD
          sudo dscl . -append /Groups/admin GroupMembership $USERNAME
          echo "SSH_USER=$USERNAME" >> $GITHUB_ENV
          echo "SSH_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "Created macOS SSH user: $USERNAME with password: $PASSWORD"

      - name: Enable SSH (Remote Login)
        run: |
          sudo systemsetup -setremotelogin on
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
          sudo systemsetup -getremotelogin

      - name: Allow SSH in Firewall
        run: |
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/sbin/sshd
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /usr/sbin/sshd

      - name: Show Access Information
        run: |
          echo "===================================="
          echo "üîê SSH ACCESS ENABLED"
          echo "Connect using:"
          echo "ssh $SSH_USER@$TAILSCALE_IP"
          echo "Password: $SSH_PASS"
          echo "===================================="
          echo "Keep workflow alive for remote access"
          while true; do
            echo "[$(date)] SSH active on $TAILSCALE_IP"
            sleep 300
          done
